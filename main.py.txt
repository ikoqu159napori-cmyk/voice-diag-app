import streamlit as st
from streamlit_mic_recorder import mic_recorder
import librosa
import numpy as np
import io
import urllib.parse

# --- è¨ºæ–­ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå‰å›ã®ã‚³ãƒ¼ãƒ‰ã‚’ç§»æ¤ï¼‰ ---
def analyze_voice(audio_bytes):
    # ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    audio_file = io.BytesIO(audio_bytes)
    y, sr = librosa.load(audio_file)

    # æ•°å€¤æŠ½å‡º
    f0, _, _ = librosa.pyin(y, fmin=librosa.note_to_hz('C2'), fmax=librosa.note_to_hz('C6'))
    avg_pitch = np.nanmean(f0)
    brightness = np.mean(librosa.feature.spectral_centroid(y=y, sr=sr)[0])
    tempo_array, _ = librosa.beat.beat_track(y=y, sr=sr)
    tempo = float(np.mean(tempo_array))
    energy = np.mean(librosa.feature.rms(y=y)[0])

    # åˆ¤å®š
    season = "å¤" if avg_pitch > 180 and brightness > 2500 else ("æ˜¥" if avg_pitch > 180 else ("å†¬" if brightness > 1800 else "ç§‹"))
    activity = energy * 100 + (tempo / 100)
    time_of_day = "æ˜¼" if activity > 6.0 else ("æ™©" if activity < 4.5 else "æœ")
    
    return f"{season} Ã— {time_of_day}", avg_pitch

# --- ç”»é¢ï¼ˆUIï¼‰ã®è¨­å®š ---
st.set_page_config(page_title="AIå£°è³ªè¨ºæ–­", page_icon="ğŸ™ï¸")
st.title("ğŸ™ï¸ AIå£°è³ª12ã‚¿ã‚¤ãƒ—è¨ºæ–­")
st.write("ã‚¹ãƒãƒ›ã®ãƒã‚¤ã‚¯ã§éŒ²éŸ³ã—ã¦ã€ã‚ãªãŸã®å£°ã®ã‚¿ã‚¤ãƒ—ã‚’è¨ºæ–­ã—ã¾ã—ã‚‡ã†ï¼")

# éŒ²éŸ³ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ã§ã‚‚å‹•ãã¾ã™ï¼‰
audio = mic_recorder(start_prompt="ğŸ”´ éŒ²éŸ³ã‚¹ã‚¿ãƒ¼ãƒˆ", stop_prompt="â¹ï¸ åœæ­¢ã—ã¦è¨ºæ–­", key='recorder')

if audio:
    st.audio(audio['bytes']) # éŒ²éŸ³ã—ãŸå£°ã‚’ç¢ºèªã§ãã‚‹
    
    with st.spinner('AIãŒè§£æä¸­...'):
        result, pitch = analyze_voice(audio['bytes'])
        
        st.success(f"è¨ºæ–­å®Œäº†ï¼ã‚ãªãŸã®å£°è³ªã¯â€¦")
        st.header(f"âœ¨ ã€ {result} ã€‘ âœ¨")
        st.write(f"ï¼ˆè§£æãƒ‡ãƒ¼ã‚¿ - é«˜ã•: {pitch:.2f}Hzï¼‰")

        # --- Xï¼ˆTwitterï¼‰ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ ---
        share_text = f"ç§ã®å£°è³ªã¯ã€{result}ã€‘ã‚¿ã‚¤ãƒ—ã§ã—ãŸï¼ğŸ™ï¸âœ¨\nAIãŒå£°ã®æˆåˆ†ã‚’åˆ†æã—ã¦è¨ºæ–­ã—ã¾ã™ã€‚\n#å£°è³ª12ã‚¿ã‚¤ãƒ—è¨ºæ–­ #AIè¨ºæ–­"
        # è‡ªåˆ†ã®ã‚µã‚¤ãƒˆURLãŒæ±ºã¾ã£ãŸã‚‰ã“ã“ã«æ›¸ãæ›ãˆã‚‹
        share_url = "https://your-app-name.streamlit.app" 
        
        encoded_text = urllib.parse.quote(share_text)
        x_share_link = f"https://twitter.com/intent/tweet?text={encoded_text}&url={share_url}"
        
        st.markdown(f'''
            <a href="{x_share_link}" target="_blank">
                <button style="background-color: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    ğ• (Twitter) ã§çµæœã‚’ã‚·ã‚§ã‚¢ã™ã‚‹
                </button>
            </a>
            ''', unsafe_allow_html=True)